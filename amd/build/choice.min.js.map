{"version":3,"file":"choice.min.js","sources":["../src/choice.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to add navigation to choice modal\n *\n * @module     format_popups/choice\n * @copyright  2021 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport config from 'core/config';\nimport Fragment from 'core/fragment';\nimport notification from 'core/notification';\nimport templates from 'core/templates';\n\nvar contextid, modname;\n\n/**\n * Initialize Choice mod actions\n *\n * @param {int} id Course module context id\n * @param {string} name Activity type\n */\nexport const init = (id, name) => {\n    'use strict';\n    contextid = id;\n    modname = name;\n\n    document.querySelector('#format_popups_activity_content').removeEventListener('click', handleLink);\n    document.querySelector('#format_popups_activity_content').addEventListener('click', handleLink);\n\n    // Disable handler for  group selection form.\n    document.querySelectorAll('form#selectgroup select').forEach(function(select) {\n        let id = select.getAttribute('id'),\n            form = select.closest('form'),\n            html;\n        if (id) {\n            let label = document.querySelector('label[for=\"' + id + '\"]');\n            select.setAttribute(id, id + '_popup');\n            if (label) {\n                label.setAttribute('for', id + '_popup');\n            }\n        }\n        html = form.innerHTML;\n        templates.replaceNodeContents('form#selectgroup', html, '');\n    });\n    document.querySelector('#format_popups_activity_content').removeEventListener('change', changeGroup, {capture: true});\n    document.querySelector('#format_popups_activity_content').addEventListener('change', changeGroup, {capture: true});\n\n    // Fix broken relative links.\n    document.querySelectorAll('a').forEach(function(anchor) {\n        if (anchor.getAttribute('href') && (anchor.getAttribute('href').search('http') !== 0)) {\n            anchor.setAttribute('href', config.wwwroot + '/mod/choice/' + anchor.getAttribute('href'));\n        }\n    });\n};\n\n/**\n * Load content for internal course links\n *\n * @param {object} e event\n */\nfunction handleLink(e) {\n    'use strict';\n    let anchor = e.target.closest('a');\n    if (anchor) {\n\n        let url = new URL(anchor.getAttribute('href')),\n            params = url.searchParams;\n\n        if (url.toString() && url.pathname.search('mod/choice/report.php') > 0) {\n            let xhttp = new XMLHttpRequest();\n            e.preventDefault();\n            e.stopPropagation();\n            xhttp.onreadystatechange = function() {\n                if (this.readyState == 4 && this.status == 200) {\n                    showReport(xhttp.responseText);\n                }\n            };\n            xhttp.open('GET', url.toString(), true);\n            xhttp.send();\n        }\n\n        if (url.toString() && url.pathname.search('mod/choice/view.php') > 0) {\n            e.preventDefault();\n            e.stopPropagation();\n            Fragment.loadFragment(\n                'format_popups',\n                'mod',\n                contextid,\n                {\n                    jsondata: JSON.stringify(params.toString()),\n                    modname: modname\n                }\n            ).then(\n                templates.replaceNodeContents.bind(templates, '#format_popups_activity_content')\n            ).fail(notification.exception);\n        }\n    }\n}\n\n/**\n * Show report page\n *\n * @param {string} response text\n */\nconst showReport = (response) => {\n    'use strict';\n    let container = document.createElement('div');\n    container.innerHTML = response;\n    container.querySelectorAll('div.downloadreport form').forEach(function(form) {\n        form.setAttribute('action', config.wwwroot + '/mod/choice/' + form.getAttribute('action'));\n    });\n    templates.replaceNodeContents(\n        '#format_popups_activity_content',\n        container.querySelector('#page-content div[role=\"main\"]').innerHTML,\n        \"require(['core/checkbox-toggleall'], function(ToggleAll) { ToggleAll.init(); });\"\n    );\n};\n\n/**\n * Handle change group selector\n *\n * @param {object} e event\n */\nconst changeGroup = (e) => {\n    let form = e.target.closest('form');\n    if (form && e.target.closest('select.custom-select')) {\n        let formdata = new FormData(form),\n            url = new URL(form.getAttribute('action')),\n            params = new URLSearchParams(formdata);\n        e.stopPropagation();\n        e.preventDefault();\n        if (config.wwwroot + '/mod/choice/view.php' === form.getAttribute('action')) {\n            Fragment.loadFragment(\n                'format_popups',\n                'mod',\n                contextid,\n                {\n                    jsondata: JSON.stringify(params.toString()),\n                    modname: modname\n                }\n            ).then(\n                templates.replaceNodeContents.bind(templates, '#format_popups_activity_content')\n            ).fail(notification.exception);\n        } else if (config.wwwroot + '/mod/choice/report.php' === url.origin + url.pathname) {\n            let xhttp = new XMLHttpRequest();\n            xhttp.onreadystatechange = function() {\n                if (this.readyState == 4 && this.status == 200) {\n                    showReport(xhttp.responseText);\n                }\n            };\n            xhttp.open('POST', form.getAttribute('action'), true);\n            xhttp.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n            xhttp.send(params.toString());\n        } else {\n            return;\n        }\n    }\n};\n"],"names":["contextid","modname","handleLink","e","anchor","target","closest","url","URL","getAttribute","params","searchParams","toString","pathname","search","xhttp","XMLHttpRequest","preventDefault","stopPropagation","onreadystatechange","this","readyState","status","showReport","responseText","open","send","loadFragment","jsondata","JSON","stringify","then","templates","replaceNodeContents","bind","fail","notification","exception","id","name","document","querySelector","removeEventListener","addEventListener","querySelectorAll","forEach","select","html","form","label","setAttribute","innerHTML","changeGroup","capture","config","wwwroot","response","container","createElement","formdata","FormData","URLSearchParams","origin","setRequestHeader"],"mappings":"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"}