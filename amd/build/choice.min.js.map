{"version":3,"sources":["../src/choice.js"],"names":["contextid","modname","init","id","name","document","querySelector","removeEventListener","handleLink","addEventListener","querySelectorAll","forEach","select","getAttribute","form","closest","html","label","setAttribute","innerHTML","templates","replaceNodeContents","changeGroup","capture","anchor","search","config","wwwroot","e","target","url","URL","params","searchParams","toString","pathname","xhttp","XMLHttpRequest","preventDefault","stopPropagation","onreadystatechange","readyState","status","showReport","responseText","open","send","Fragment","loadFragment","jsondata","JSON","stringify","then","bind","fail","notification","exception","response","container","createElement","formdata","FormData","URLSearchParams","origin","setRequestHeader"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to add navigation to choice modal\n *\n * @module     format_popups/choice\n * @copyright  2021 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport config from 'core/config';\nimport Fragment from 'core/fragment';\nimport notification from 'core/notification';\nimport templates from 'core/templates';\n\nvar contextid, modname;\n\n/**\n * Initialize Choice mod actions\n *\n * @param {int} id Course module context id\n * @param {string} name Activity type\n */\nexport const init = (id, name) => {\n    'use strict';\n    contextid = id;\n    modname = name;\n\n    document.querySelector('#format_popups_activity_content').removeEventListener('click', handleLink);\n    document.querySelector('#format_popups_activity_content').addEventListener('click', handleLink);\n\n    // Disable handler for  group selection form.\n    document.querySelectorAll('form#selectgroup select').forEach(function(select) {\n        let id = select.getAttribute('id'),\n            form = select.closest('form'),\n            html;\n        if (id) {\n            let label = document.querySelector('label[for=\"' + id + '\"]');\n            select.setAttribute(id, id + '_popup');\n            if (label) {\n                label.setAttribute('for', id + '_popup');\n            }\n        }\n        html = form.innerHTML;\n        templates.replaceNodeContents('form#selectgroup', html, '');\n    });\n    document.querySelector('#format_popups_activity_content').removeEventListener('change', changeGroup, {capture: true});\n    document.querySelector('#format_popups_activity_content').addEventListener('change', changeGroup, {capture: true});\n\n    // Fix broken relative links.\n    document.querySelectorAll('a').forEach(function(anchor) {\n        if (anchor.getAttribute('href') && (anchor.getAttribute('href').search('http') !== 0)) {\n            anchor.setAttribute('href', config.wwwroot + '/mod/choice/' + anchor.getAttribute('href'));\n        }\n    });\n};\n\n/**\n * Load content for internal course links\n *\n * @param {object} e event\n */\nfunction handleLink(e) {\n    'use strict';\n    let anchor = e.target.closest('a');\n    if (anchor) {\n\n        let url = new URL(anchor.getAttribute('href')),\n            params = url.searchParams;\n\n        if (url.toString() && url.pathname.search('mod/choice/report.php') > 0) {\n            let xhttp = new XMLHttpRequest();\n            e.preventDefault();\n            e.stopPropagation();\n            xhttp.onreadystatechange = function() {\n                if (this.readyState == 4 && this.status == 200) {\n                    showReport(xhttp.responseText);\n                }\n            };\n            xhttp.open('GET', url.toString(), true);\n            xhttp.send();\n        }\n\n        if (url.toString() && url.pathname.search('mod/choice/view.php') > 0) {\n            e.preventDefault();\n            e.stopPropagation();\n            Fragment.loadFragment(\n                'format_popups',\n                'mod',\n                contextid,\n                {\n                    jsondata: JSON.stringify(params.toString()),\n                    modname: modname\n                }\n            ).then(\n                templates.replaceNodeContents.bind(templates, '#format_popups_activity_content')\n            ).fail(notification.exception);\n        }\n    }\n}\n\n/**\n * Show report page\n *\n * @param {string} response text\n */\nconst showReport = (response) => {\n    'use strict';\n    let container = document.createElement('div');\n    container.innerHTML = response;\n    container.querySelectorAll('div.downloadreport form').forEach(function(form) {\n        form.setAttribute('action', config.wwwroot + '/mod/choice/' + form.getAttribute('action'));\n    });\n    templates.replaceNodeContents(\n        '#format_popups_activity_content',\n        container.querySelector('#page-content div[role=\"main\"]').innerHTML,\n        \"require(['core/checkbox-toggleall'], function(ToggleAll) { ToggleAll.init(); });\"\n    );\n};\n\n/**\n * Handle change group selector\n *\n * @param {object} e event\n */\nconst changeGroup = (e) => {\n    let form = e.target.closest('form');\n    if (form && e.target.closest('select.custom-select')) {\n        let formdata = new FormData(form),\n            url = new URL(form.getAttribute('action')),\n            params = new URLSearchParams(formdata);\n        e.stopPropagation();\n        e.preventDefault();\n        if (config.wwwroot + '/mod/choice/view.php' === form.getAttribute('action')) {\n            Fragment.loadFragment(\n                'format_popups',\n                'mod',\n                contextid,\n                {\n                    jsondata: JSON.stringify(params.toString()),\n                    modname: modname\n                }\n            ).then(\n                templates.replaceNodeContents.bind(templates, '#format_popups_activity_content')\n            ).fail(notification.exception);\n        } else if (config.wwwroot + '/mod/choice/report.php' === url.origin + url.pathname) {\n            let xhttp = new XMLHttpRequest();\n            xhttp.onreadystatechange = function() {\n                if (this.readyState == 4 && this.status == 200) {\n                    showReport(xhttp.responseText);\n                }\n            };\n            xhttp.open('POST', form.getAttribute('action'), true);\n            xhttp.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n            xhttp.send(params.toString());\n        } else {\n            return;\n        }\n    }\n};\n"],"file":"choice.min.js"}