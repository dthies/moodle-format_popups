{"version":3,"file":"popups.min.js","sources":["../src/popups.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to initialise modal with listeners\n *\n * @module     format_popups/popups\n * @copyright  2021 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Ajax from 'core/ajax';\nimport config from 'core/config';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport Modal from 'core/modal_cancel';\nimport notification from 'core/notification';\nimport templates from 'core/templates';\nimport loadChapter from 'format_popups/book';\nimport resize from 'format_popups/embed';\n\nvar root;\n\n/**\n * Initialize modal and listeners\n *\n * @param {int} contextid Course context id\n * @param {int} courseid Course id\n * @param {int} displaysection Single section to display\n */\nexport const init = (contextid, courseid, displaysection) => {\n    'use strict';\n\n    if (root) {\n        return;\n    }\n\n    createModal(contextid, courseid, displaysection);\n};\n\nconst createModal = async(contextid, courseid, displaysection) => {\n    try {\n        const modal = await Modal.create({\n            large: true,\n            title: 'title',\n            body: '<div id=\"format_popups_activity_content\"></div>'\n        });\n        modal.contextid = contextid;\n        modal.courseid = courseid;\n        modal.displaysection = displaysection;\n        modal.modules = [];\n        modal.modulecount = document.querySelectorAll('.activity').length;\n        root = modal;\n        registerListeners.bind(modal)();\n\n        return await Ajax.call([{\n            methodname: 'format_popups_get_available_mods',\n            args: {\n                contextid: modal.contextid\n            },\n            done: function(modules) {\n                this.modules = modules;\n            }.bind(modal),\n            fail: notification.exception\n        }]);\n    } catch (e) {\n        notification.exception(e);\n    }\n\n    return false;\n};\n\n/**\n * Update activities on course page and optionally manual completion\n */\nexport const updatePage = function() {\n    'use strict';\n\n    if (document.body.classList.contains('popups_update')) {\n        return;\n    }\n    document.body.classList.add('popups_update');\n\n    Fragment.loadFragment(\n        'format_popups',\n        'page',\n        root.contextid,\n        {\n            displaysection: root.displaysection\n        }\n    ).then(function(html, js) {\n        document.body.classList.remove('popups_update');\n        if (!html.length) {\n            return;\n        }\n        templates.replaceNodeContents('div.course-content', html, js);\n        document.querySelectorAll('form#sectionmenu select').forEach(function(selector) {\n            let form = selector.closest('form'),\n                html;\n            selector.removeAttribute('id');\n            html = form.innerHTML;\n            templates.replaceNodeContents(form, html, '');\n        });\n        return;\n    }).fail(notification.exception);\n\n    Ajax.call([{\n        methodname: 'format_popups_get_available_mods',\n        args: {\n            contextid: root.contextid\n        },\n        done: function(modules) {\n            root.modules = modules;\n        },\n        fail: notification.exception\n    }]);\n};\n\n/**\n * Register listeners for modal\n *\n */\nfunction registerListeners() {\n    'use strict';\n\n    // Open Modal when view is clicked.\n    document.querySelector('body').addEventListener('click', function(e) {\n        let anchor = e.target.closest('a');\n        if (anchor && anchor.getAttribute('href')\n            && !anchor.getAttribute('onclick')\n            && anchor.getAttribute('href').match('http')\n            && anchor.closest('div.course-content, #format_popups_activity_content, #courseindex-content')\n        ) {\n            let url = new URL(anchor.getAttribute('href')),\n                id = url.searchParams.get('id');\n            this.modules.forEach(function(module) {\n                if ((id == module.id &&\n                        !url.searchParams.get('downloadown') &&\n                        config.wwwroot + '/mod/' + module.modname + '/view.php' === url.origin + url.pathname) ||\n                    (url.searchParams.get('a') == module.instance &&\n                        config.wwwroot + '/mod/' + module.modname + '/report.php' === url.origin + url.pathname\n                            && module.modname === 'h5pactivity')\n                ) {\n                        e.preventDefault();\n                        e.stopPropagation();\n                        this.setTitle(module.title);\n                        Fragment.loadFragment(\n                            'format_popups',\n                            'mod',\n                            module.contextid,\n                            {\n                                jsondata: JSON.stringify(url.searchParams.toString()),\n                                modname: module.modname,\n                                path: url.pathname\n                            }\n                        ).then(\n                            templates.replaceNodeContents.bind(templates, '#format_popups_activity_content')\n                        ).fail(notification.exception);\n                        this.show();\n                }\n            }.bind(this));\n        }\n    }.bind(this));\n\n    // Update the page so new completion and conditions show.\n    this.getRoot().on(ModalEvents.hidden, updatePage);\n\n    // Add event listener for file upload complete.\n    document.addEventListener('focusin', function() {\n        'use strict';\n\n        // Check whether number of modules changed. if so we need to update.\n        if (this.modulecount === document.querySelectorAll('.activity').length) {\n            return;\n        }\n        this.modulecount = document.querySelectorAll('.activity').length;\n\n        Ajax.call([{\n            methodname: 'format_popups_get_available_mods',\n            args: {\n                contextid: this.contextid\n            },\n            done: function(modules) {\n                this.modules = modules;\n            }.bind(this),\n            fail: notification.exception\n        }]);\n    }.bind(this));\n\n    // Listen for manual completion update.\n    document.querySelector('div.course-content').addEventListener('submit', handleCompletion.bind(this));\n\n    // Remove module listener.\n    this.getRoot().on(ModalEvents.hidden, function() {\n        let content = document.querySelector('#format_popups_activity_content');\n        if (content) {\n            content.removeEventListener('click', loadChapter);\n            content.removeEventListener('resize', resize);\n        }\n    });\n\n    // Navigation links within the course page.\n    document.querySelectorAll(\n        '#secondary-navigation, #nav-drawer, div.course-content, #courseindex'\n    ).forEach(function(container) {\n        container.addEventListener('click', function(e) {\n            const anchor = e.target.closest('a') || e.target;\n            if (anchor && anchor.getAttribute('href') && !anchor.closest('.moodle-actionmenu')) {\n                const href = anchor.getAttribute('href'),\n                    url = new URL(href),\n                    params = url.searchParams;\n                if (href.search(config.wwwroot + '/course/view.php') === 0) {\n                    if (!params.has('sesskey') && !href.includes('#') && params.get('id') === this.courseid) {\n                        this.displaysection = params.get('section');\n                    }\n                } else if (href.search(config.wwwroot + '/course/section.php') === 0) {\n                    this.displaysection = params.get('id');\n                } else {\n                    return;\n                }\n                e.preventDefault();\n                e.stopPropagation();\n                window.history.pushState({}, null, url);\n                updatePage();\n            }\n        }.bind(this));\n    }.bind(this));\n\n    // Handle form navigation on the course page.\n    document.querySelector('div.course-content').addEventListener('change', function(e) {\n        let form = e.target.closest('form#sectionmenu');\n        if (form) {\n            let formdata = new FormData(form),\n                url = new URL(config.wwwroot + formdata.get('jump')),\n                params = url.searchParams;\n            if (params.get('id') === this.courseid) {\n                this.displaysection = params.get('section');\n                updatePage();\n                e.preventDefault();\n                e.stopPropagation();\n            }\n        }\n    }.bind(this));\n\n    // Remove original form listeners.\n    document.querySelectorAll('form#sectionmenu select, form.togglecompletion').forEach(function(selector) {\n        let form = selector.closest('form'),\n            html;\n        selector.removeAttribute('id');\n        html = form.innerHTML;\n        templates.replaceNodeContents(form, html, '');\n    });\n\n    // If window looses focus and and modal is empty, then close the modal. This\n    // happens when a SCORM package is opened in external window.\n    window.addEventListener('blur', function() {\n        if (\n            document.getElementById('format_popups_activity_content') &&\n            window.getComputedStyle(document.getElementById('format_popups_activity_content')).height == '0px'\n        ) {\n           this.hide();\n        }\n    }.bind(this));\n\n    this.getRoot().on(ModalEvents.hidden, templates.replaceNodeContents.bind(\n        templates,\n        '#format_popups_activity_content',\n        '<div style=\"height: 275px;\"></div>',\n        ''\n    ));\n}\n\n/**\n * Submit form and load response\n *\n * @param {object} e event\n */\nfunction handleCompletion(e) {\n    'use strict';\n    let form = e.target.closest('form.togglecompletion');\n    if (form) {\n        let formdata = new FormData(form),\n            url = new URL(form.getAttribute('action')),\n            params = new URLSearchParams(formdata);\n\n        if (config.wwwroot + '/course/togglecompletion.php' === url.origin + url.pathname) {\n            let xhttp = new XMLHttpRequest(),\n                spinner = document.createElement('div');\n            e.preventDefault();\n            e.stopPropagation();\n            params.append('fromajax', 1);\n            spinner.setAttribute('class', 'ajaxworking');\n            form.appendChild(spinner);\n\n            // This is not the fasted. but best code reuse.  First complete ajax request\n            // for completion update ignoring result, then reload the page.\n            xhttp.onreadystatechange = function() {\n                if (this.readyState == 4 && this.status == 200) {\n                    updatePage();\n                }\n            };\n            xhttp.open('POST', form.getAttribute('action'), true);\n            xhttp.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n            xhttp.send(params.toString());\n        }\n    }\n}\n\nexport default {\n    init: init,\n    updatePage: updatePage\n};\n"],"names":["root","init","contextid","courseid","displaysection","createModal","async","modal","Modal","create","large","title","body","modules","modulecount","document","querySelectorAll","length","registerListeners","bind","Ajax","call","methodname","args","done","fail","notification","exception","e","updatePage","classList","contains","add","loadFragment","then","html","js","remove","replaceNodeContents","forEach","selector","form","closest","removeAttribute","innerHTML","querySelector","addEventListener","anchor","target","getAttribute","match","url","URL","id","searchParams","get","module","config","wwwroot","modname","origin","pathname","instance","preventDefault","stopPropagation","setTitle","jsondata","JSON","stringify","toString","path","templates","show","this","getRoot","on","ModalEvents","hidden","handleCompletion","content","removeEventListener","loadChapter","resize","container","href","params","search","has","includes","window","history","pushState","formdata","FormData","getElementById","getComputedStyle","height","hide","URLSearchParams","xhttp","XMLHttpRequest","spinner","createElement","append","setAttribute","appendChild","onreadystatechange","readyState","status","open","setRequestHeader","send"],"mappings":"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"}