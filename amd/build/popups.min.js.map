{"version":3,"sources":["../src/popups.js"],"names":["init","contextid","courseid","displaysection","ModalFactory","create","large","title","body","then","modal","modules","modulecount","document","querySelectorAll","length","registerListeners","bind","Ajax","call","methodname","args","done","fail","notification","exception","updatePage","Fragment","loadFragment","html","js","templates","replaceNodeContents","forEach","selector","form","closest","removeAttribute","innerHTML","querySelector","addEventListener","e","anchor","target","getAttribute","match","url","URL","id","searchParams","get","module","config","wwwroot","modname","origin","pathname","instance","preventDefault","stopPropagation","setTitle","jsondata","JSON","stringify","toString","path","show","getRoot","on","ModalEvents","hidden","handleCompletion","content","removeEventListener","loadChapter","resize","container","href","search","params","has","includes","formdata","FormData","URLSearchParams","xhttp","XMLHttpRequest","spinner","createElement","append","setAttribute","appendChild","onreadystatechange","readyState","status","open","setRequestHeader","send"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to initialise modal with listeners\n *\n * @module     format_popups/popups\n * @package    format_popups\n * @copyright  2021 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Ajax from 'core/ajax';\nimport config from 'core/config';\nimport Fragment from 'core/fragment';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport notification from 'core/notification';\nimport templates from 'core/templates';\nimport loadChapter from 'format_popups/book';\nimport resize from 'format_popups/embed';\n\n/**\n * Initialize modal and listeners\n *\n * @param {int} contextid Course context id\n * @param {int} courseid Course id\n * @param {int} displaysection Single section to display\n */\nexport const init = (contextid, courseid, displaysection) => {\n    'use strict';\n\n    ModalFactory.create({\n        large: true,\n        title: 'title',\n        body: '<div id=\"format_popups_activity_content\"></div>'\n    }).then(function(modal) {\n        modal.contextid = contextid;\n        modal.courseid = courseid;\n        modal.displaysection = displaysection;\n        modal.modules = [];\n        modal.modulecount = document.querySelectorAll('.activity').length;\n        registerListeners.bind(modal)();\n\n        return Ajax.call([{\n            methodname: 'format_popups_get_available_mods',\n            args: {\n                contextid: modal.contextid\n            },\n            done: function(modules) {\n                this.modules = modules;\n            }.bind(modal),\n            fail: notification.exception\n        }]);\n    }).fail(notification.exception);\n};\n\n/**\n * Update activities on course page and optionally manual completion\n */\nfunction updatePage() {\n    'use strict';\n\n    Fragment.loadFragment(\n        'format_popups',\n        'page',\n        this.contextid,\n        {\n            displaysection: this.displaysection\n        }\n    ).then(function(html, js) {\n        if (!html.length) {\n            return;\n        }\n        templates.replaceNodeContents('div.course-content', html, js);\n        document.querySelectorAll('form#sectionmenu select').forEach(function(selector) {\n            let form = selector.closest('form'),\n                html;\n            selector.removeAttribute('id');\n            html = form.innerHTML;\n            templates.replaceNodeContents(form, html, '');\n        });\n        return;\n    }).fail(notification.exception);\n\n    Ajax.call([{\n        methodname: 'format_popups_get_available_mods',\n        args: {\n            contextid: this.contextid\n        },\n        done: function(modules) {\n            this.modules = modules;\n        }.bind(this),\n        fail: notification.exception\n    }]);\n}\n\n/**\n * Register listeners for modal\n *\n */\nfunction registerListeners() {\n    'use strict';\n\n    // Open Modal when view is clicked.\n    document.querySelector('body').addEventListener('click', function(e) {\n        let anchor = e.target.closest('a');\n        if (anchor && anchor.getAttribute('href')\n            && !anchor.getAttribute('onclick')\n            && anchor.getAttribute('href').match('http')\n            && anchor.closest('div.course-content, #format_popups_activity_content')\n        ) {\n            let url = new URL(anchor.getAttribute('href')),\n                id = url.searchParams.get('id');\n            this.modules.forEach(function(module) {\n                if ((id == module.id &&\n                        !url.searchParams.get('downloadown') &&\n                        config.wwwroot + '/mod/' + module.modname + '/view.php' === url.origin + url.pathname) ||\n                    (url.searchParams.get('a') == module.instance &&\n                        config.wwwroot + '/mod/' + module.modname + '/report.php' === url.origin + url.pathname\n                            && module.modname === 'h5pactivity')\n                ) {\n                        e.preventDefault();\n                        e.stopPropagation();\n                        this.setTitle(module.title);\n                        templates.replaceNodeContents(\n                            '#format_popups_activity_content',\n                            '<div style=\"height: 275px;\"></div>',\n                            ''\n                        );\n                        Fragment.loadFragment(\n                            'format_popups',\n                            'mod',\n                            module.contextid,\n                            {\n                                jsondata: JSON.stringify(url.searchParams.toString()),\n                                modname: module.modname,\n                                path: url.pathname\n                            }\n                        ).then(\n                            templates.replaceNodeContents.bind(templates, '#format_popups_activity_content')\n                        ).fail(notification.exception);\n                        this.show();\n                }\n            }.bind(this));\n        }\n    }.bind(this));\n\n    // Update the page so new completion and conditions show.\n    this.getRoot().on(ModalEvents.hidden, updatePage.bind(this));\n\n    // Add event listener for file upload complete.\n    document.addEventListener('focusin', function() {\n        'use strict';\n\n        // Check whether number of modules changed. if so we need to update.\n        if (this.modulecount === document.querySelectorAll('.activity').length) {\n            return;\n        }\n        this.modulecount = document.querySelectorAll('.activity').length;\n\n        Ajax.call([{\n            methodname: 'format_popups_get_available_mods',\n            args: {\n                contextid: this.contextid\n            },\n            done: function(modules) {\n                this.modules = modules;\n            }.bind(this),\n            fail: notification.exception\n        }]);\n    }.bind(this));\n\n    // Listen for manual completion update.\n    document.querySelector('div.course-content').addEventListener('submit', handleCompletion.bind(this));\n\n    // Remove module listener.\n    this.getRoot().on(ModalEvents.hidden, function() {\n        let content = document.querySelector('#format_popups_activity_content');\n        if (content) {\n            content.removeEventListener('click', loadChapter);\n            content.removeEventListener('resize', resize);\n        }\n    });\n\n    // Navigation links within the course page.\n    document.querySelectorAll('#page-navbar, #nav-drawer, div.course-content').forEach(function(container) {\n        container.addEventListener('click', function(e) {\n            let anchor = e.target.closest('a') || e.target;\n            if (anchor && anchor.getAttribute('href')) {\n                let href = anchor.getAttribute('href');\n                if (href.search(config.wwwroot + '/course/view.php') === 0) {\n                    let url = new URL(href),\n                        params = url.searchParams;\n                    if (!params.has('sesskey') && !href.includes('#') && params.get('id') === this.courseid) {\n                        this.displaysection = params.get('section');\n                        updatePage.bind(this)();\n                        e.preventDefault();\n                        e.stopPropagation();\n                    }\n                }\n            }\n        }.bind(this));\n    }.bind(this));\n\n    // Handle form navigation on the course page.\n    document.querySelector('div.course-content').addEventListener('change', function(e) {\n        let form = e.target.closest('form#sectionmenu');\n        if (form) {\n            let formdata = new FormData(form),\n                url = new URL(config.wwwroot + formdata.get('jump')),\n                params = url.searchParams;\n            if (params.get('id') === this.courseid) {\n                this.displaysection = params.get('section');\n                updatePage.bind(this)();\n                e.preventDefault();\n                e.stopPropagation();\n            }\n        }\n    }.bind(this));\n\n    // Remove original form listeners.\n    document.querySelectorAll('form#sectionmenu select, form.togglecompletion').forEach(function(selector) {\n        let form = selector.closest('form'),\n            html;\n        selector.removeAttribute('id');\n        html = form.innerHTML;\n        templates.replaceNodeContents(form, html, '');\n    });\n}\n\n/**\n * Submit form and load response\n *\n * @param {object} e event\n */\nfunction handleCompletion(e) {\n    'use strict';\n    let form = e.target.closest('form.togglecompletion');\n    if (form) {\n        let formdata = new FormData(form),\n            url = new URL(form.getAttribute('action')),\n            params = new URLSearchParams(formdata);\n\n        if (config.wwwroot + '/course/togglecompletion.php' === url.origin + url.pathname) {\n            let xhttp = new XMLHttpRequest(),\n                spinner = document.createElement('div');\n            e.preventDefault();\n            e.stopPropagation();\n            params.append('fromajax', 1);\n            spinner.setAttribute('class', 'ajaxworking');\n            form.appendChild(spinner);\n\n            // This is not the fasted. but best code reuse.  First complete ajax request\n            // for completion update ignoring result, then reload the page.\n            xhttp.onreadystatechange = function(modal) {\n                if (this.readyState == 4 && this.status == 200) {\n                    updatePage.bind(modal)();\n                }\n            }.bind(xhttp, this);\n            xhttp.open('POST', form.getAttribute('action'), true);\n            xhttp.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n            xhttp.send(params.toString());\n        }\n    }\n}\n"],"file":"popups.min.js"}