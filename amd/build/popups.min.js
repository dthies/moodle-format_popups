define("format_popups/popups",["exports","core/ajax","core/config","core/fragment","core/modal_events","core/modal_factory","core/notification","core/templates","format_popups/book","format_popups/embed"],(function(_exports,_ajax,_config,_fragment,_modal_events,_modal_factory,_notification,_templates,_book,_embed){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Module to initialise modal with listeners
   *
   * @module     format_popups/popups
   * @copyright  2021 Daniel Thies <dethies@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */var root;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.updatePage=_exports.init=_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_config=_interopRequireDefault(_config),_fragment=_interopRequireDefault(_fragment),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),_book=_interopRequireDefault(_book),_embed=_interopRequireDefault(_embed);const init=(contextid,courseid,displaysection)=>{_modal_factory.default.create({large:!0,title:"title",body:'<div id="format_popups_activity_content"></div>'}).then((function(modal){return modal.contextid=contextid,modal.courseid=courseid,modal.displaysection=displaysection,modal.modules=[],modal.modulecount=document.querySelectorAll(".activity").length,root=modal,registerListeners.bind(modal)(),_ajax.default.call([{methodname:"format_popups_get_available_mods",args:{contextid:modal.contextid},done:function(modules){this.modules=modules}.bind(modal),fail:_notification.default.exception}])})).fail(_notification.default.exception)};_exports.init=init;const updatePage=function(){_fragment.default.loadFragment("format_popups","page",root.contextid,{displaysection:root.displaysection}).then((function(html,js){html.length&&(_templates.default.replaceNodeContents("div.course-content",html,js),document.querySelectorAll("form#sectionmenu select").forEach((function(selector){let html,form=selector.closest("form");selector.removeAttribute("id"),html=form.innerHTML,_templates.default.replaceNodeContents(form,html,"")})))})).fail(_notification.default.exception),_ajax.default.call([{methodname:"format_popups_get_available_mods",args:{contextid:root.contextid},done:function(modules){root.modules=modules},fail:_notification.default.exception}])};function registerListeners(){document.querySelector("body").addEventListener("click",function(e){let anchor=e.target.closest("a");if(anchor&&anchor.getAttribute("href")&&!anchor.getAttribute("onclick")&&anchor.getAttribute("href").match("http")&&anchor.closest("div.course-content, #format_popups_activity_content, #courseindex-content")){let url=new URL(anchor.getAttribute("href")),id=url.searchParams.get("id");this.modules.forEach(function(module){(id==module.id&&!url.searchParams.get("downloadown")&&_config.default.wwwroot+"/mod/"+module.modname+"/view.php"===url.origin+url.pathname||url.searchParams.get("a")==module.instance&&_config.default.wwwroot+"/mod/"+module.modname+"/report.php"===url.origin+url.pathname&&"h5pactivity"===module.modname)&&(e.preventDefault(),e.stopPropagation(),this.setTitle(module.title),_fragment.default.loadFragment("format_popups","mod",module.contextid,{jsondata:JSON.stringify(url.searchParams.toString()),modname:module.modname,path:url.pathname}).then(_templates.default.replaceNodeContents.bind(_templates.default,"#format_popups_activity_content")).fail(_notification.default.exception),this.show())}.bind(this))}}.bind(this)),this.getRoot().on(_modal_events.default.hidden,updatePage.bind(this)),document.addEventListener("focusin",function(){this.modulecount!==document.querySelectorAll(".activity").length&&(this.modulecount=document.querySelectorAll(".activity").length,_ajax.default.call([{methodname:"format_popups_get_available_mods",args:{contextid:this.contextid},done:function(modules){this.modules=modules}.bind(this),fail:_notification.default.exception}]))}.bind(this)),document.querySelector("div.course-content").addEventListener("submit",handleCompletion.bind(this)),this.getRoot().on(_modal_events.default.hidden,(function(){let content=document.querySelector("#format_popups_activity_content");content&&(content.removeEventListener("click",_book.default),content.removeEventListener("resize",_embed.default))})),document.querySelectorAll("#page-navbar, #nav-drawer, div.course-content, #courseindex").forEach(function(container){container.addEventListener("click",function(e){let anchor=e.target.closest("a")||e.target;if(anchor&&anchor.getAttribute("href")){let href=anchor.getAttribute("href");if(0===href.search(_config.default.wwwroot+"/course/view.php")){let params=new URL(href).searchParams;params.has("sesskey")||href.includes("#")||params.get("id")!==this.courseid||(this.displaysection=params.get("section"),e.preventDefault(),e.stopPropagation(),updatePage.bind(this)())}}}.bind(this))}.bind(this)),document.querySelector("div.course-content").addEventListener("change",function(e){let form=e.target.closest("form#sectionmenu");if(form){let formdata=new FormData(form),params=new URL(_config.default.wwwroot+formdata.get("jump")).searchParams;params.get("id")===this.courseid&&(this.displaysection=params.get("section"),updatePage.bind(this)(),e.preventDefault(),e.stopPropagation())}}.bind(this)),document.querySelectorAll("form#sectionmenu select, form.togglecompletion").forEach((function(selector){let html,form=selector.closest("form");selector.removeAttribute("id"),html=form.innerHTML,_templates.default.replaceNodeContents(form,html,"")})),window.addEventListener("blur",function(){document.getElementById("format_popups_activity_content")&&"0px"==window.getComputedStyle(document.getElementById("format_popups_activity_content")).height&&this.hide()}.bind(this)),this.getRoot().on(_modal_events.default.hidden,_templates.default.replaceNodeContents.bind(_templates.default,"#format_popups_activity_content",'<div style="height: 275px;"></div>',""))}function handleCompletion(e){let form=e.target.closest("form.togglecompletion");if(form){let formdata=new FormData(form),url=new URL(form.getAttribute("action")),params=new URLSearchParams(formdata);if(_config.default.wwwroot+"/course/togglecompletion.php"===url.origin+url.pathname){let xhttp=new XMLHttpRequest,spinner=document.createElement("div");e.preventDefault(),e.stopPropagation(),params.append("fromajax",1),spinner.setAttribute("class","ajaxworking"),form.appendChild(spinner),xhttp.onreadystatechange=function(){4==this.readyState&&200==this.status&&updatePage()},xhttp.open("POST",form.getAttribute("action"),!0),xhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhttp.send(params.toString())}}}_exports.updatePage=updatePage;var _default={init:init,updatePage:updatePage};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=popups.min.js.map